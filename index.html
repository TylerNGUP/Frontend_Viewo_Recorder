<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 28px;
            margin-top: 20px;
        }
        .video-container {
            background: linear-gradient(145deg, #2c3e50, #1a2530);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            margin-bottom: 24px;
        }
        .video-container:hover {
            transform: translateY(-2px);
        }
        video {
            width: 100%;
            max-height: 600px;
            display: block;
        }
        .control-panel {
            margin-top: 28px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            background: #f8fafc;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        button {
            transition: all 0.3s ease;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        button:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            20% {
                transform: scale(25, 25);
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none;
        }
        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .speed-control {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            padding: 16px 20px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        select {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        label {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        h1 {
            color: #2d3748;
            font-weight: 800;
            text-align: center;
            position: relative;
            padding-bottom: 12px;
        }
        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            margin-right: 8px;
            border: 2px solid #cbd5e0;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        input[type="checkbox"]:checked {
            background: #667eea;
            border-color: #667eea;
        }
        input[type="checkbox"]:checked::before {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .video-label {
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            border-radius: 0 0 8px 0;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <h1 class="text-3xl font-bold mb-6">屏幕录制工具</h1>
    
    <div class="app-container">
        <div class="mb-8">
            <div class="video-label">实时预览</div>
            <div class="video-container">
                <video id="preview" autoplay muted></video>
            </div>
        </div>
        
        <div class="mb-8">
            <div class="video-label">录制回放</div>
            <div class="video-container">
                <video id="recording" controls></video>
            </div>
        </div>
        
        <div class="speed-control">
            <label for="playbackSpeed" class="text-gray-700 font-medium">播放速度:</label>
            <select id="playbackSpeed" class="border rounded p-2 bg-white focus:border-blue-400">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
            </select>
        </div>
        
        <div class="control-panel">
            <button id="startBtn" class="bg-gradient-to-r from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 text-white px-5 py-2.5 rounded flex items-center gap-2">
                <i class="fa fa-play"></i> 开始录制
            </button>
            <button id="pauseBtn" disabled class="bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white px-5 py-2.5 rounded flex items-center gap-2">
                <i class="fa fa-pause"></i> 暂停录制
            </button>
            <button id="resumeBtn" disabled class="bg-gradient-to-r from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 text-white px-5 py-2.5 rounded flex items-center gap-2">
                <i class="fa fa-play"></i> 继续录制
            </button>
            <button id="stopBtn" disabled class="bg-gradient-to-r from-red-400 to-red-600 hover:from-red-500 hover:to-red-700 text-white px-5 py-2.5 rounded flex items-center gap-2">
                <i class="fa fa-stop"></i> 停止录制
            </button>
            <button id="downloadBtn" disabled class="bg-gradient-to-r from-purple-400 to-purple-600 hover:from-purple-500 hover:to-purple-700 text-white px-5 py-2.5 rounded flex items-center gap-2">
                <i class="fa fa-download"></i> 下载录制
            </button>
            
            <div class="ml-auto checkbox-wrapper">
                <label class="flex items-center gap-2 text-gray-700 font-medium cursor-pointer">
                    <input type="checkbox" id="micCheckbox" checked class="rounded text-blue-500">
                    录制麦克风声音
                </label>
            </div>
        </div>
    </div>

    <script>
        // JavaScript代码保持不变
        const preview = document.getElementById('preview');
        const recording = document.getElementById('recording');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const micCheckbox = document.getElementById('micCheckbox');
        const playbackSpeed = document.getElementById('playbackSpeed');
        
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let micStream;
        let audioContext;
        
        // 设置播放速度
        playbackSpeed.addEventListener('change', () => {
            recording.playbackRate = parseFloat(playbackSpeed.value);
        });

        startBtn.addEventListener('click', async () => {
            try {
                // 重置之前的录制数据
                recordedChunks = [];
                
                // 获取屏幕流 - 仅视频，音频将单独处理
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false // 不直接从屏幕捕获音频，后面单独处理
                });
                
                // 创建媒体流数组，至少包含视频轨道
                let mediaStreams = [stream];
                
                // 如果勾选了麦克风，则获取麦克风流
                if (micCheckbox.checked) {
                    micStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        },
                        video: false
                    });
                    mediaStreams.push(micStream);
                }
                
                // 合并所有流
                const combinedStream = new MediaStream();
                mediaStreams.forEach(ms => {
                    ms.getTracks().forEach(track => {
                        combinedStream.addTrack(track);
                    });
                });
                
                // 检测浏览器支持的视频格式
                const mimeType = MediaRecorder.isTypeSupported('video/mp4') 
                    ? 'video/mp4' 
                    : 'video/webm;codecs=vp9,opus';
                
                // 配置录制参数以确保更好的兼容性
                const options = {
                    mimeType: mimeType,
                    videoBitsPerSecond: 5000000, // 5Mbps
                    audioBitsPerSecond: 128000,  // 128kbps
                };
                
                // 创建媒体录制器
                mediaRecorder = new MediaRecorder(combinedStream, options);
                
                // 显示预览
                preview.srcObject = stream;
                
                // 处理录制数据
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    // 创建视频 blob
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    // 设置录制视频
                    recording.src = videoUrl;
                    recording.onloadedmetadata = () => {
                        downloadBtn.disabled = false;
                    };
                    
                    // 停止所有流
                    stopAllStreams();
                };
                
                // 开始录制
                mediaRecorder.start();
                
                // 更新UI状态
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                downloadBtn.disabled = true;
                
            } catch (error) {
                console.error('录制错误:', error);
                alert(`无法开始录制: ${error.message}`);
                
                // 重置UI状态
                resetUI();
                
                // 停止所有流
                stopAllStreams();
            }
        });

        pauseBtn.addEventListener('click', () => {
            mediaRecorder.pause();
            pauseBtn.disabled = true;
            resumeBtn.disabled = false;
        });

        resumeBtn.addEventListener('click', () => {
            mediaRecorder.resume();
            pauseBtn.disabled = false;
            resumeBtn.disabled = true;
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            
            // 更新UI状态
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.disabled = true;
            stopBtn.disabled = true;
        });

        downloadBtn.addEventListener('click', () => {
            if (recordedChunks.length === 0) return;
            
            // 创建视频 blob
            const mimeType = MediaRecorder.isTypeSupported('video/mp4') 
                ? 'video/mp4' 
                : 'video/webm;codecs=vp9,opus';
            const blob = new Blob(recordedChunks, { type: mimeType });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // 根据格式设置文件名
            const extension = mimeType.startsWith('video/mp4') ? 'mp4' : 'webm';
            a.download = `recording-${new Date().toISOString().replace(/:/g, '-')}.${extension}`;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        });
        
        // 停止所有流的辅助函数
        function stopAllStreams() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }
        
        // 重置UI状态的辅助函数
        function resetUI() {
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.disabled = true;
            stopBtn.disabled = true;
            downloadBtn.disabled = true;
        }
    </script>
</body>
</html>
